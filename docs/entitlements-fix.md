# Entitlements File Fix

This document describes how to fix malformed entitlements files that cause Expo prebuild to fail.

## Problem

Expo prebuild fails with:
```
SyntaxError: [ios.entitlements]: Expected "/*" but "\"" found.
```

This is caused by a malformed `.entitlements` file with a broken comment containing a stray quote.

## Solution

### 1. Clean Entitlements Block in app.json

Ensure your `app.json` has a clean entitlements block:

```json
{
  "expo": {
    "ios": {
      "entitlements": {
        "aps-environment": "production",
        "com.apple.developer.associated-domains": [],
        "keychain-access-groups": []
      }
    }
  }
}
```

This ensures Expo generates clean, properly formatted entitlements files.

### 2. Nuclear Clean

Delete all entitlements files and regenerate:

**On macOS/Linux:**
```bash
# Delete all entitlements files
find ios -name "*.entitlements" -type f -delete

# Or use the provided script
chmod +x scripts/clean-entitlements.sh
./scripts/clean-entitlements.sh
```

**On Windows (PowerShell):**
```powershell
# Delete all entitlements files
Get-ChildItem -Path ios -Filter "*.entitlements" -Recurse | Remove-Item -Force

# Or use the provided script
.\scripts\clean-entitlements.ps1
```

### 3. Full Nuclear Clean

Remove the entire ios folder and regenerate:

```bash
# Remove ios folder completely
rm -rf ios/

# Remove Expo cache
rm -rf node_modules/.expo

# Clean and regenerate
npx expo prebuild --clean
```

## Verification

After running `npx expo prebuild --clean`, check that:

1. Entitlements files are generated in `ios/UniPilot/UniPilot.entitlements`
2. The file has proper XML structure (no malformed comments)
3. The file contains the entitlements from `app.json`

## Expected Entitlements File Structure

A clean entitlements file should look like:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>aps-environment</key>
    <string>production</string>
    <key>com.apple.developer.associated-domains</key>
    <array/>
    <key>keychain-access-groups</key>
    <array/>
</dict>
</plist>
```

## Troubleshooting

If you still see syntax errors:

1. **Check app.json** - Ensure the entitlements block is valid JSON
2. **Delete ios folder** - Remove the entire `ios/` folder and regenerate
3. **Clear Expo cache** - Remove `node_modules/.expo`
4. **Check for manual edits** - Don't manually edit entitlements files; let Expo generate them
5. **Verify XML structure** - If you must check the file, ensure it's valid XML

## Notes

- Entitlements files are auto-generated by Expo from `app.json`
- Don't manually edit `.entitlements` files - they will be overwritten
- Always use `app.json` to configure entitlements
- The nuclear clean ensures a fresh start with clean files

